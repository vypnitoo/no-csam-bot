generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model Guild {
  id                  String   @id
  name                String
  moderatorRoleIds    String
  detectionEnabled    Boolean  @default(true)
  autoDelete          Boolean  @default(true)
  autoBan             Boolean  @default(true)
  alertChannelId      String?
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  detections Detection[]
  bans       Ban[]
  auditLogs  AuditLog[]

  @@map("guilds")
}

model User {
  id             String   @id
  username       String
  discriminator  String
  offenseCount   Int      @default(0)
  globallyBanned Boolean  @default(false)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  detections       Detection[]
  bans             Ban[]
  moderatorReviews ModeratorReview[]
  auditLogs        AuditLog[]

  @@map("users")
}

model Detection {
  id                String   @id @default(uuid())
  userId            String
  guildId           String
  channelId         String
  messageId         String
  imageUrl          String
  imageHash         String
  detectionMethod   String
  confidenceScore   Float
  flagged           Boolean  @default(false)
  actionTaken       String?
  metadata          String?
  createdAt         DateTime @default(now())

  user              User    @relation(fields: [userId], references: [id])
  guild             Guild   @relation(fields: [guildId], references: [id])
  moderatorReview   ModeratorReview?

  @@map("detections")
}

model Ban {
  id                String   @id @default(uuid())
  userId            String
  guildId           String?
  level             Int      @default(1)
  reason            String
  banType           String
  active            Boolean  @default(true)
  expiresAt         DateTime?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  user              User    @relation(fields: [userId], references: [id])
  guild             Guild?  @relation(fields: [guildId], references: [id])

  @@map("bans")
}

model ModeratorReview {
  id                String   @id @default(uuid())
  detectionId       String   @unique
  reviewerId        String?
  status            String   @default("pending")
  decision          String?
  notes             String?
  reviewedAt        DateTime?
  createdAt         DateTime @default(now())

  detection         Detection @relation(fields: [detectionId], references: [id])
  reviewer          User?     @relation(fields: [reviewerId], references: [id])

  @@map("moderator_reviews")
}

model HashDatabase {
  id                String   @id @default(uuid())
  hash              String   @unique
  hashType          String
  source            String?
  severity          String   @default("high")
  active            Boolean  @default(true)
  createdAt         DateTime @default(now())

  @@map("hash_database")
}

model AuditLog {
  id                String   @id @default(uuid())
  userId            String?
  guildId           String?
  action            String
  targetType        String?
  targetId          String?
  details           String?
  ipAddress         String?
  createdAt         DateTime @default(now())

  user              User?   @relation(fields: [userId], references: [id])
  guild             Guild?  @relation(fields: [guildId], references: [id])

  @@map("audit_logs")
}
